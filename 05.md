# deviseでユーザデータを登録するときに、他モデルのデータを同時に生成したいが、何をすればいいかわからない。
# 解答記述欄

deviseのafter_sign_up_forの中に保存処理を記述しましょう。そうすることでユーザー登録直後にデータを保存できます。





# レビュー記述欄
質問のように、複数モデルを同時に生成するには、
1. 複数モデルに関する入力フォームを作成して、
2. モデルに子モデルを同時生成するためのメソッドを付与して、
3. コントローラーでparamsの受け取りを準備します。

具体的には、
1. Viewでは、fields_forを使います。
2. Modelにaccepts_nested_attributes_forを記述します。
3. Controllerで受け取るパラメータを定義します。

以降、親をUserモデル、子がAddressモデルという形式で説明します。
順番に説明します。

1. fields_for

<%= form_for @user do |f| %>
  <%= f.text_field :name %>

  <%= f.fields_for :addresses do |af| %>
    <%= af.email_field :email %>
  <% end %>
<% end %>
上記の記述で複数モデルに関する入力をコントローラーに送信できます。

form_forやform_withは、原則一つのモデルしか扱えません。
複数モデルにするには、form_forやform_withの中にfields_forをつかう必要があります。

fields_forの対象モデルは、form_forの対象モデルの子モデルです。
そのため、form_forの対象モデルにhas_manyかhas_oneが必須です。

accepts_nested_attributes_for
class User < ApplicationRecord
  has_many :addresses
  accepts_nested_attributes_for :addresses, allow_destroy: true
end
fields_forによって、複数モデルのパラメータがまとまって送信されます。
このとき、モデルにaccepts_nested_attributes_forを記述すると、
親モデルを保存したときに、子モデルが同時に保存されます。

allow_destroyは、親モデルの更新時に子モデルのレコードを削除可能にするオプションです。
allow_destroyを記述しないと、子モデルの削除ができません。

controller deviseはdevise/registrations_controllerのcreateアクションで登録処理を行っています。 deviseのコントローラーは、rails g devise:controllers xxxxでコントローラーを生成できます。
変更を加える点のみ記述します。

class Devise::RegisterationController < Devise::RegistrationsController
  before_action :configure_sign_up_params, only: [:create]
  # before_action :configure_account_update_params, only: [:update]

  # GET /resource/sign_up
  def new
    # superの記述は消す！
    @user = User.new
    @user.addresses.new
  end

  ...

  # If you have extra params to permit, append them to the sanitizer.
  def configure_sign_up_params
    devise_parameter_sanitizer.permit(:sign_up, keys: [:name, addresses_attributes:[:id, :email, :_destroy]])
  end

  ...

end
まずnewアクションの中身を変更します。
superの記述を削除して、userインスタンスとaddressインスタンスを生成します。

@user.addresses.newと書くことで、親レコードとの結びつきが行われます。
またこの記述を省略すると、Viewでaddressの入力欄、つまり子モデルの入力欄が表示されないので注意してください。

次にパラメータについて。
コード2行目のconfigure_sign_up_paramsのコメントアウトを外して、create前に受け取るパラメータを設定するようにします。

では、configure_sign_up_paramsの中で、実際に受け取るパラメータを記述しましょう。
受け取るパラメータはkeys:の後ろに記述します。

子モデルのパラメータをaddresses_attirbutesと記述します。attributesの前はhas_manyやhas_oneの記述に対応します。
その中で、:id, :_destroy,その他カラムを記述します。
通常:idと:_destroyは記述しません。
これは先述したallow_destroyオプションに対応するもので、:idと:_destroyを受け取れるようにしておく必要があります。
